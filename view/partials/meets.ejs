<head>
  <link rel="stylesheet" href="/static/css/meet_card.css" />
</head>

<div class="meet-card" data-meet-id="<%= meet._id %>">
  <img src="<%= meet.image || '/static/images/map_placeholder.png' %>" alt="Meet Image" class="meet-image" />

  <h3 class="meet-title">
    <%= meet.title %>
  </h3>

  <div class="meet-meta">
    <p><strong>Date:</strong>
      <%= meet.date || '-' %>
    </p>
    <p><strong>Time:</strong>
      <%= meet.time || '-' %>
    </p>
    <p><strong>Duration:</strong> <%= meet.duration || '-' %></p>
    <p><strong>Max People:</strong>
      <%= meet.maxPeople || '-' %>
    </p>
    <p><strong>Location:</strong>
      <%= meet.address || meet.location || '-' %>
    </p>
  </div>

  <% if (meet.description) { %>
    <p class="meet-description">
      <%= meet.description %>
    </p>
    <% } %>

      <div class="meet-actions">
        <a href="/meet/<%= meet._id %>" class="view-btn">View</a>

        <% const userId='demoUserId' ; %>
          <% const isMember=Array.isArray(meet.members) && meet.members.some(m=> m.id === userId); %>
            <% if (!isMember) { %>
              <form method="POST" action="/meet/<%= meet._id %>/join" class="join-leave-form" data-action="join">
                <input type="hidden" name="userId" value="<%= userId %>" />
                <button type="submit" class="join-btn">Join Meet</button>
              </form>
              <% } else { %>
                <form method="POST" action="/meet/<%= meet._id %>/cancel" class="join-leave-form" data-action="leave">
                  <input type="hidden" name="userId" value="<%= userId %>" />
                  <button type="submit" class="cancel-btn">Leave Meet</button>
                </form>
                <% } %>
      </div>
</div>

<script>
  // Helper to update the join/leave button and re-attach event listeners
  function updateJoinLeaveButton(card, isMember) {
    const meetId = card.getAttribute("data-meet-id");
    let formHtml;
    if (isMember) {
      formHtml = `<form method='POST' action='/meet/${meetId}/cancel' class='join-leave-form' data-action='leave'><input type='hidden' name='userId' value='demoUserId' /><button type='submit' class='cancel-btn'>Leave Meet</button></form>`;
    } else {
      formHtml = `<form method='POST' action='/meet/${meetId}/join' class='join-leave-form' data-action='join'><input type='hidden' name='userId' value='demoUserId' /><button type='submit'>Join Meet</button></form>`;
    }
    card.querySelector(".meet-actions").innerHTML = formHtml;
    attachJoinLeaveListeners(card);
  }

  // Attach event listeners to join/leave forms
  function attachJoinLeaveListeners(scope) {
    (scope
      ? scope.querySelectorAll(".join-leave-form")
      : document.querySelectorAll(".join-leave-form")
    ).forEach((form) => {
      if (!form.hasAttribute("data-listener")) {
        form.setAttribute("data-listener", "true");
        form.addEventListener("submit", async function (e) {
          e.preventDefault();
          const card = form.closest(".meet-card");
          const meetId = card.getAttribute("data-meet-id");
          const action = form.getAttribute("data-action");
          const url = form.action;
          const formData = new FormData(form);
          await fetch(url, { method: "POST", body: formData });
          if (action === "join") {
            alert("You joined the meet!");
            updateJoinLeaveButton(card, true);
          } else {
            alert("You left the meet.");
            updateJoinLeaveButton(card, false);
          }
        });
      }
    });
  }

  // Initial attach for all join/leave forms
  attachJoinLeaveListeners();
</script>