<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TravelLink</title>
    <link rel="stylesheet" href="/static/header.css" />
    <link rel="stylesheet" href="/static/homepage.css" />
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header>
      <a href="/">
        <img src="/static/images/tllogo.png" alt="Travel Link logo" />
      </a>

      <input type="text" placeholder="Beach walk, 'party', 'relaxing'" />

      <nav>
        <a href="/user/create-meet"><button>Create Meet</button></a>
        <a href="/meets"><button>Manage Meets</button></a>
      </nav>

      <section>
        <a href="/notifications">
          <!-- need -->
          <img src="/static/images/alarm.svg" alt="Notifications" />
        </a>
        <a href="/profile">
          <!-- need -->
          <img src="/static/images/profiel.svg" alt="Profile" />
        </a>
      </section>
    </header>

    <main>
      <section>
        <h2>Find a meet near <em>you!</em></h2>
        <div class="meet-row">
          <% meets.forEach(meet => { %>
          <div class="meet-card" data-meet-id="<%= meet._id %>">
            <img
              src="<%= meet.image || '/static/images/map_placeholder.png' %>"
              alt="Meet Image"
              style="
                max-width: 220px;
                max-height: 120px;
                object-fit: cover;
                border-radius: 8px;
                margin-bottom: 0.5rem;
              "
            />
            <div
              style="
                display: flex;
                align-items: center;
                gap: 1rem;
                font-size: 0.98rem;
                color: #444;
                margin-bottom: 0.3rem;
              "
            >
              <span><strong>Date:</strong> <%= meet.date || '-' %></span>
              <span><strong>Time:</strong> <%= meet.time || '-' %></span>
            </div>
            <div style="margin-bottom: 0.3rem; color: #666">
              <strong>Location:</strong> <%= meet.address || meet.location ||
              '-' %>
            </div>
            <div
              class="meet-actions"
              style="
                display: flex;
                gap: 0.5rem;
                width: 100%;
                margin-top: 0.5rem;
              "
            >
              <a
                href="/meet/<%= meet._id %>"
                class="view-btn"
                style="
                  background: #007bff;
                  color: #fff;
                  padding: 0.4rem 1rem;
                  border-radius: 5px;
                  text-decoration: none;
                  font-weight: bold;
                "
                >View</a
              >
              <% const userId = 'demoUserId'; %> <% const isMember =
              Array.isArray(meet.members) && meet.members.some(m => m.id ===
              userId); %> <% if (!isMember) { %>
              <form
                method="POST"
                action="/meet/<%= meet._id %>/join"
                class="join-leave-form"
                data-action="join"
                style="display: inline"
              >
                <input type="hidden" name="userId" value="<%= userId %>" />
                <button
                  type="submit"
                  style="
                    background: #28a745;
                    color: #fff;
                    border: none;
                    border-radius: 5px;
                    padding: 0.4rem 1rem;
                    font-weight: bold;
                  "
                >
                  Join Meet
                </button>
              </form>
              <% } else { %>
              <form
                method="POST"
                action="/meet/<%= meet._id %>/cancel"
                class="join-leave-form"
                data-action="leave"
                style="display: inline"
              >
                <input type="hidden" name="userId" value="<%= userId %>" />
                <button
                  type="submit"
                  class="cancel-btn"
                  style="
                    background: #dc3545;
                    color: #fff;
                    border: none;
                    border-radius: 5px;
                    padding: 0.4rem 1rem;
                    font-weight: bold;
                  "
                >
                  Leave Meet
                </button>
              </form>
              <% } %>
            </div>
          </div>
          <% }) %>
        </div>
      </section>
      <section>
        <h2>Discover meets near <em>you!</em></h2>
        <div class="meet-row">
          <% meets.forEach(meet => { %>
          <div class="meet-card">
            <h3><%= meet.meetingName %></h3>
            <p><%= meet.location %></p>
            <p><%= meet.description %></p>
            <a href="/meet/<%= meet._id %>">View</a>
          </div>
          <% }) %>
        </div>
      </section>
      <section>
        <h2>View all nearby locations</h2>
        <img
          src="/static/images/map_placeholder.png"
          alt="Map showing nearby locations"
        />
      </section>
    </main>
    <style>
      .meet-row {
        display: flex;
        gap: 2rem;
        margin: 1.5rem 0;
        flex-wrap: wrap;
      }
      .meet-card {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        padding: 1rem 1.5rem;
        min-width: 180px;
        max-width: 250px;
      }
      .meet-card h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
      }
      .meet-card p {
        margin: 0 0 0.3rem 0;
        font-size: 0.95rem;
        color: #666;
      }
      .meet-card a {
        margin-top: 0.5rem;
        color: #007bff;
        text-decoration: underline;
        font-weight: bold;
        cursor: pointer;
      }
      .meet-actions {
        margin-top: 0.5rem;
        display: flex;
        gap: 0.5rem;
        width: 100%;
      }
      .meet-actions form {
        flex: 1;
      }
      .cancel-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 0.5rem;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
      }
      @media (max-width: 700px) {
        .meet-row {
          flex-direction: column;
          gap: 1rem;
        }
        .meet-card {
          max-width: 100%;
          min-width: 0;
          width: 100%;
        }
      }
    </style>
    <script>
      // Helper to update the join/leave button and re-attach event listeners
      function updateJoinLeaveButton(card, isMember) {
        const meetId = card.getAttribute("data-meet-id");
        let formHtml;
        if (isMember) {
          formHtml = `<form method='POST' action='/meet/${meetId}/cancel' class='join-leave-form' data-action='leave'><input type='hidden' name='userId' value='demoUserId' /><button type='submit' class='cancel-btn'>Leave Meet</button></form>`;
        } else {
          formHtml = `<form method='POST' action='/meet/${meetId}/join' class='join-leave-form' data-action='join'><input type='hidden' name='userId' value='demoUserId' /><button type='submit'>Join Meet</button></form>`;
        }
        card.querySelector(".meet-actions").innerHTML = formHtml;
        attachJoinLeaveListeners(card);
      }

      // Attach event listeners to join/leave forms
      function attachJoinLeaveListeners(scope) {
        (scope
          ? scope.querySelectorAll(".join-leave-form")
          : document.querySelectorAll(".join-leave-form")
        ).forEach((form) => {
          if (!form.hasAttribute("data-listener")) {
            form.setAttribute("data-listener", "true");
            form.addEventListener("submit", async function (e) {
              e.preventDefault();
              const card = form.closest(".meet-card");
              const meetId = card.getAttribute("data-meet-id");
              const action = form.getAttribute("data-action");
              const url = form.action;
              const formData = new FormData(form);
              await fetch(url, { method: "POST", body: formData });
              if (action === "join") {
                alert("You joined the meet!");
                updateJoinLeaveButton(card, true);
              } else {
                alert("You left the meet.");
                updateJoinLeaveButton(card, false);
              }
            });
          }
        });
      }

      // Initial attach for all join/leave forms
      attachJoinLeaveListeners();
    </script>
  </body>
</html>
